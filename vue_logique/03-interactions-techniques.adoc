= Interactions techniques entre services

== Objectif

Cette section complète la vue logique en décrivant les interactions techniques précises entre les services de l’application Beep. Elle permet d’anticiper les contraintes d’intégration, de performance et de résilience en explicitant les mécanismes d’appel, les formats échangés et les points de couplage.

== Principes de communication

[cols="1,3", options="header"]
|===
| Mode
| Description

| Appels REST synchrones
| Utilisés pour les interactions classiques (authentification, messages, gestion des rôles, etc.)

| Événements pub/sub (Kafka ou autre)
| Utilisés pour les notifications, la modération, ou les traitements asynchrones (ex: archivage, journalisation).

| Partage de cache ou session
| Ex: Redis pour sessions utilisateurs ou présence en ligne.

| Base de données partagée (évité)
| Chaque service possède idéalement sa propre base. Les accès croisés sont évités sauf nécessité critique (ex: supervision).
|===

== Carte des interactions principales

[mermaid]
----
graph LR
    Authentification -->|REST| Utilisateurs
    Utilisateurs -->|REST| Serveurs
    Serveurs -->|REST| Canaux
    Canaux -->|REST| Messages
    Messages -->|Event| Notifications
    Messages -->|Event| Modération
    Notifications -->|Push| Clients
    Recherche -->|REST| Utilisateurs
    Recherche -->|REST| Messages
----

== Formats d’échange

=== REST – Exemple JSON : Création de message

[source,json]
----
POST /channels/:id/messages

{
  "authorId": "user-123",
  "content": "Salut tout le monde !",
  "attachments": []
}
----

Réponse :

[source,json]
----
{
  "id": "msg-456",
  "timestamp": "2025-05-27T15:00:00Z",
  "status": "created"
}
----

=== Événement – Nouveau message

[source,json]
----
event: "message.created"

{
  "channelId": "chan-789",
  "messageId": "msg-456",
  "authorId": "user-123",
  "type": "text"
}
----

== Sécurité des interactions

- Toutes les APIs REST sont protégées par JWT ou cookie sécurisé.
- Les événements sont filtrés côté consommateur selon les droits utilisateur.
- Les appels inter-services utilisent mTLS ou un service mesh si disponible.

== Évolutions prévues

- Introduction de gRPC pour certaines interactions haute-fréquence.
- Ajout d’un service broker pour les workflows multi-services (ex: temporal.io).
- Spécification OpenAPI pour tous les endpoints publics.
